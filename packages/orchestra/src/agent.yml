version: 1
id: galaxy_api_agent_minimal
kind: agent_pipeline
description: Client-side demo agent executing read-only Galaxy API calls

start: api_histories

inputs:
  transcripts:
    type: transcript_stream
  context:
    type: object

state:
  histories:
    type: array
  history_id:
    type: string
  contents:
    type: array
  dataset_id:
    type: string
  dataset:
    type: object

nodes:
  api_histories:
    type: executor
    run:
      op: api.call
      target: galaxy.history.list
      input:
        limit: 10
    emit:
      state.histories: result
    next: pick_history

  pick_history:
    type: planner
    prompt: |
      Select a history from the list.
    enum_from:
      state: histories
      field: id
    tools:
      - route
    output_schema:
      type: object
      required: [next, history_id]
      properties:
        next:
          type: string
          enum: [api_contents]
        history_id:
          type: string
    emit:
      state.history_id: history_id
    next: ${next}

  api_contents:
    type: executor
    run:
      op: api.call
      target: galaxy.history.contents
      input:
        history_id: ${state.history_id}
    emit:
      state.contents: result
    next: pick_dataset

  pick_dataset:
    type: executor
    run:
      op: state.select
      input:
        from: ${state.contents}
        filter:
          field: history_content_type
          equals: dataset
        index: 0
        field: id
    emit:
      state.dataset_id: result
    next: api_dataset

  api_dataset:
    type: executor
    run:
      op: api.call
      target: galaxy.dataset.show
      input:
        dataset_id: ${state.dataset_id}
    emit:
      state.dataset: result
    next: done

  done:
    type: terminal
    emit:
      dataset: ${state.dataset}
