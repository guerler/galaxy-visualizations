version: 1
id: default
kind: agent_pipeline
description: Client-side demo agent executing read-only Galaxy API calls
start: api_histories
inputs:
  transcripts:
    type: transcript_stream
  context:
    type: object
state:
  histories:
    type: array
  selection:
    type: object
  history:
    type: object
  contents:
    type: array
  dataset:
    type: object
nodes:
  api_histories:
    type: executor
    run:
      op: api.call
      target: galaxy.histories.get
      input:
        limit: 10
    emit:
      state.histories: result
    next: pick_history
  pick_history:
    type: planner
    prompt: |
      Select a history from the list.
    enum_from:
      state: histories
      field: name
    output_schema:
      type: object
      required: [next, history_name]
      properties:
        next:
          type: string
          enum: [api_contents]
        history_name:
          type: string
    emit:
      state.selection:
        history_name:
          $ref: result.history_name
        next:
          $ref: result.next
    next:
      $ref: state.selection.next
  api_contents:
    type: executor
    run:
      op: api.call
      target: galaxy.histories.show.contents.get
      input:
        history_id:
          $expr:
            op: lookup
            from:
              $ref: state.histories
            match:
              field: name
              equals:
                $ref: state.selection.history_name
            select: id
    emit:
      state.history:
        name:
          $ref: state.selection.history_name
        id:
          $ref: run.input.history_id
      state.contents: result
    next: pick_dataset
  pick_dataset:
    type: planner
    prompt: |
      Select a dataset from the list.
    enum_from:
      state: contents
      field: id
    output_schema:
      type: object
      required: [next, dataset_id]
      properties:
        next:
          type: string
          enum: [api_dataset]
        dataset_id:
          type: string
    emit:
      state.selection:
        dataset_id:
          $ref: result.dataset_id
        next:
          $ref: result.next
    next:
      $ref: state.selection.next
  api_dataset:
    type: executor
    run:
      op: api.call
      target: galaxy.datasets.show.get
      input:
        dataset_id:
          $ref: state.selection.dataset_id
    emit:
      state.dataset: result
    next: done
  done:
    type: terminal
    output:
      history:
        id:
          $ref: state.history.id
        name:
          $ref: state.history.name
      dataset_id:
        $ref: state.selection.dataset_id
