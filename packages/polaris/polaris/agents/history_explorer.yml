version: 1
id: history_explorer
kind: agent_pipeline
description: Browse Galaxy histories and generate an AI-powered summary of contents

start: fetch_histories

inputs:
  transcripts:
    type: transcript_stream
  context:
    type: object

state:
  histories:
    type: array
  selected_history:
    type: object
  contents:
    type: array
  dataset_count:
    type: integer
  has_errors:
    type: boolean
  summary:
    type: string

nodes:
  fetch_histories:
    type: executor
    run:
      op: api.call
      target: galaxy.histories.get
      input:
        limit: 10
    emit:
      state.histories: result
    next: select_history

  select_history:
    type: planner
    prompt: |
      You are helping a user explore their Galaxy histories.
      Select one history from the list to inspect based on the conversation context.
      If the user mentioned a specific history, select that one.
      Otherwise, select the most recently updated history.
    enum_from:
      state: histories
      field: name
    output_schema:
      type: object
      required: [history_name]
      properties:
        history_name:
          type: string
    emit:
      state.selected_history:
        name:
          $ref: result.history_name
    next: fetch_contents

  fetch_contents:
    type: executor
    run:
      op: api.call
      target: galaxy.histories.show.contents.get
      input:
        history_id:
          $expr:
            op: lookup
            from:
              $ref: state.histories
            match:
              field: name
              equals:
                $ref: state.selected_history.name
            select: id
    emit:
      state.selected_history:
        id:
          $ref: run.input.history_id
      state.contents: result
    next: compute_stats

  compute_stats:
    type: compute
    emit:
      state.dataset_count:
        $expr:
          op: len
          arg:
            $ref: state.contents
      state.has_errors:
        $expr:
          op: any
          from:
            $ref: state.contents
          field: state
          equals: error
    next: generate_summary

  generate_summary:
    type: reasoning
    prompt: |
      Write a concise, helpful summary of this Galaxy history for the user.

      Describe:
      - What types of data are present (e.g., FASTQ files, BAM alignments, VCF variants)
      - The general workflow or analysis that was performed (if apparent)
      - Any issues that need attention (failed datasets, errors)

      Keep it conversational and informative. Do not just list numbers.
    input:
      history_name:
        $ref: state.selected_history.name
      contents:
        $ref: state.contents
      dataset_count:
        $ref: state.dataset_count
      has_errors:
        $ref: state.has_errors
    emit:
      state.summary:
        $ref: result
    next: done

  done:
    type: terminal
    output:
      history:
        id:
          $ref: state.selected_history.id
        name:
          $ref: state.selected_history.name
      dataset_count:
        $ref: state.dataset_count
      has_errors:
        $ref: state.has_errors
      summary:
        $ref: state.summary
