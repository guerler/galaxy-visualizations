version: 1
id: report_generator
kind: agent_pipeline
description: Generate publication-ready methods sections from Galaxy history analysis

start: fetch_histories

inputs:
  transcripts:
    type: transcript_stream
  context:
    type: object

state:
  histories:
    type: array
  selected_history:
    type: object
  contents:
    type: array
  jobs:
    type: array
  citations:
    type: array
  workflow_analysis:
    type: string
  report:
    type: string

nodes:
  # Step 1: Fetch available histories
  fetch_histories:
    type: executor
    run:
      op: api.call
      target: galaxy.histories.get
      input:
        limit: 20
    emit:
      state.histories: result
    next: select_history

  # Step 2: Use AI to select the appropriate history based on user request
  select_history:
    type: planner
    prompt: |
      You are helping a researcher generate a methods section for their publication.
      Select the history that best matches what the user wants to document.
      If the user mentioned a specific analysis or history name, select that one.
      Otherwise, select the most recently updated history with completed jobs.
    enum_from:
      state: histories
      field: name
    output_schema:
      type: object
      required: [history_name]
      properties:
        history_name:
          type: string
    emit:
      state.selected_history:
        name:
          $ref: result.history_name
    next: fetch_contents

  # Step 3: Fetch the history contents to get dataset information
  fetch_contents:
    type: executor
    run:
      op: api.call
      target: galaxy.histories.show.contents.get
      input:
        history_id:
          $expr:
            op: lookup
            from:
              $ref: state.histories
            match:
              field: name
              equals:
                $ref: state.selected_history.name
            select: id
    emit:
      state.selected_history:
        id:
          $ref: run.input.history_id
      state.contents: result
    next: fetch_jobs

  # Step 4: Fetch jobs associated with this history
  # Note: Using job summaries for now - full details are too verbose for LLM context
  # TODO: Add $map expression to extract only relevant fields from job details
  fetch_jobs:
    type: executor
    run:
      op: api.call
      target: galaxy.jobs.get
      input:
        history_id:
          $ref: state.selected_history.id
        limit: 25
    emit:
      state.jobs: result
    next: fetch_citations

  # Step 5: Fetch citations for tools used in this history
  fetch_citations:
    type: executor
    run:
      op: api.call
      target: galaxy.histories.show.citations.get
      input:
        history_id:
          $ref: state.selected_history.id
    emit:
      state.citations: result
    next: analyze_workflow

  # Step 6: Use AI to understand the analysis workflow
  analyze_workflow:
    type: reasoning
    prompt: |
      Analyze the jobs and datasets to understand the analysis workflow that was performed.

      Identify:
      1. The overall type of analysis (RNA-seq, variant calling, ChIP-seq, etc.)
      2. The sequence of tools used and their purpose
      3. Key parameters that would be important to report
      4. Input data types and output data types

      Provide a structured understanding of what was done.
    input:
      history_name:
        $ref: state.selected_history.name
      contents:
        $ref: state.contents
      jobs:
        $ref: state.jobs
    emit:
      state.workflow_analysis:
        $ref: result
    next: generate_methods

  # Step 7: Generate the publication-ready methods section
  generate_methods:
    type: reasoning
    prompt: |
      Write a publication-ready Methods section for a scientific paper based on this Galaxy analysis.

      Guidelines:
      - Use passive voice ("Reads were aligned..." not "We aligned reads...")
      - Include tool names and versions when available
      - Describe the workflow in logical order
      - Mention key parameters that affect results
      - Be concise but complete enough for reproducibility
      - Format for a typical bioinformatics publication

      Structure the methods section with clear paragraphs for:
      1. Data preprocessing (if applicable)
      2. Main analysis steps
      3. Quality control
      4. Post-processing or filtering

      Include a "Citations" section at the end with the tool references.
    input:
      history_name:
        $ref: state.selected_history.name
      workflow_analysis:
        $ref: state.workflow_analysis
      jobs:
        $ref: state.jobs
      citations:
        $ref: state.citations
    emit:
      state.report:
        $ref: result
    next: done

  # Terminal node - return the generated report
  done:
    type: terminal
    output:
      history:
        id:
          $ref: state.selected_history.id
        name:
          $ref: state.selected_history.name
      job_count:
        $expr:
          op: len
          arg:
            $ref: state.jobs
      methods_section:
        $ref: state.report
      citations:
        $ref: state.citations
